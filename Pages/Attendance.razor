@page "/attendance"
@page "/attendance/{EventId:int}"
@using EventEase.Models
@using EventEase.Services
@inject EventService EventService

<PageTitle>EventEase - Attendance Tracker</PageTitle>

<div class="page-header">
    <h1>Attendance Tracker</h1>
    <p class="subtitle">View registration and attendance data for events</p>
</div>

<div class="form-group">
    <label for="eventFilter">Filter by Event</label>
    <select id="eventFilter" class="form-control" @onchange="OnEventFilterChanged">
        <option value="0">All Events</option>
        @foreach (var e in events)
        {
            <option value="@e.Id" selected="@(e.Id == selectedEventId)">@e.Title</option>
        }
    </select>
</div>

@if (selectedEventId > 0)
{
    var selectedEvent = EventService.GetEventById(selectedEventId);
    if (selectedEvent != null)
    {
        <div class="attendance-summary">
            <h3>@selectedEvent.Title</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number">@selectedEvent.CurrentAttendees</span>
                    <span class="stat-label">Registered</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">@selectedEvent.MaxCapacity</span>
                    <span class="stat-label">Capacity</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">@selectedEvent.AvailableSpots</span>
                    <span class="stat-label">Available</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">@CalculatePercentage(selectedEvent)%</span>
                    <span class="stat-label">Fill Rate</span>
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: @CalculatePercentage(selectedEvent)%"></div>
            </div>
        </div>
    }
}

<h3>Registrations</h3>

@if (filteredRegistrations.Count == 0)
{
    <p class="empty-state">No registrations found.</p>
}
else
{
    <table class="data-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Event</th>
                <th>Registered</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var reg in filteredRegistrations)
            {
                var eventItem = EventService.GetEventById(reg.EventId);
                <tr>
                    <td>@reg.FullName</td>
                    <td>@reg.Email</td>
                    <td>@(eventItem?.Title ?? "Unknown")</td>
                    <td>@reg.RegisteredAt.ToString("MMM dd, yyyy h:mm tt")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Parameter]
    public int EventId { get; set; }

    private List<EventModel> events = new();
    private List<RegistrationModel> filteredRegistrations = new();
    private int selectedEventId;

    protected override void OnInitialized()
    {
        events = EventService.GetAllEvents();
        selectedEventId = EventId;
        LoadRegistrations();
    }

    private void OnEventFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedEventId = id;
            LoadRegistrations();
        }
    }

    private void LoadRegistrations()
    {
        filteredRegistrations = selectedEventId > 0
            ? EventService.GetRegistrationsForEvent(selectedEventId)
            : EventService.GetAllRegistrations();
    }

    private int CalculatePercentage(EventModel e)
    {
        if (e.MaxCapacity == 0) return 0;
        return (int)((double)e.CurrentAttendees / e.MaxCapacity * 100);
    }
}
